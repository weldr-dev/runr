# v0.6 Plan: Hybrid Workflow (Productivity + Auditability)

**Status:** Draft
**Date:** 2026-01-06

---

## Problem Statement

Runr has two competing goals:

1. **Productivity** - Keep momentum, route around friction, ship fast
2. **Reliability** - Deterministic, auditable, receipt-backed execution

Currently, when the meta-agent hits STOPPED (review loops, timeouts), it bypasses Runr by manually committing and merging. This works for productivity but creates audit gaps.

**The insight:** We don't need to choose. We need **provenance on everything** - whether Runr did it or the agent did it manually.

---

## Proposed Solution: Two Modes + Intervention Tracking

### Mode 1: Flow Mode (Default)

Ship fast, but leave a trail.

**Rules (3 max):**
1. Always run typecheck + tests before final merge to main
2. Always produce a receipt artifact (diffstat + patch) at end of each task
3. If blocked > N minutes or review loop, may finish manually but must record what was done

**Behavior:**
- Manual commits/merges allowed
- Orchestration edits allowed
- Receipts still generated (visibility floor)

### Mode 2: Ledger Mode (Strict)

Everything through Runr, fully auditable.

**Rules (3 max):**
1. All changes land via Runr checkpoints + submit (no direct merge)
2. If STOPPED, only allowed: edit task → resume, bundle, submit, or escalate
3. Every task must attach verification evidence logs

**Behavior:**
- No direct merges to main
- No manual commits inside STOPPED recovery
- Conflicts handled via submit flow

---

## New Commands / Features

### 1. `runr intervene` (Priority: High) ✅ IMPLEMENTED

Record manual work done outside Runr's normal flow.

```bash
runr intervene <run_id> \
  --note "Fixed TS error in game.ts" \
  --cmd "npm run typecheck" \
  --cmd "npm test"
```

**Creates:**
```
.runr/runs/<run_id>/interventions/<timestamp>.json
{
  "timestamp": "2026-01-06T12:00:00Z",
  "note": "Fixed TS error in game.ts",
  "commands": [
    { "cmd": "npm run typecheck", "exit_code": 0, "duration_ms": 2340 },
    { "cmd": "npm test", "exit_code": 0, "duration_ms": 8120 }
  ],
  "files_changed": ["src/game.ts"],
  "commit_sha": "abc123" // if committed
}
```

**Why:** Bridges the audit gap when agent works outside Runr.

---

### 2. `runr audit` (Priority: High) ✅ IMPLEMENTED

Timeline view of project history - Runr + manual + gaps.

```bash
runr audit --since v0.5.0
runr audit --range main~50..main
```

**Output:**
```
Timeline: main~50..main

[RUNR] abc1234 - Task 01: Setup project structure
       Run: 20260106-001122 | Checkpoint | Tier: tier2 | Evidence: ✓

[RUNR] def5678 - Task 02: Add game logic
       Run: 20260106-002233 | Checkpoint | Tier: tier2 | Evidence: ✓

[MANUAL] 789abcd - fix: TS error in game.ts
         Intervention: ✓ (linked to run 20260106-002233)

[RUNR] cde9012 - Task 03: Add UI components
       Run: 20260106-003344 | Checkpoint | Tier: tier1 | Evidence: ✓

[GAP] fff3456 - misc cleanup
      No receipt, no intervention record

Summary:
  Runr checkpoints: 3
  Manual (with intervention): 1
  Gaps (no provenance): 1
```

**Why:** Answer "did the whole development process go well?" at a glance.

---

### 3. Review Loop Diagnostics (Priority: Medium)

When `review_loop_detected`, surface what's causing it.

**Current:** Just stops with `review_loop_detected`

**Proposed:** Structured diagnosis in stop event:
```json
{
  "stop_reason": "review_loop_detected",
  "loop_count": 3,
  "last_review_requests": [
    "Include npm run typecheck output",
    "Add test for edge case",
    "Include npm run typecheck output"  // repeated!
  ],
  "unmet_checks": ["typecheck_output_missing"],
  "suggestion": "Task may need clearer acceptance criteria"
}
```

**Why:** Turn opaque failures into actionable fixes.

---

### 4. Commit Conventions (Priority: Low)

Standard trailers/prefixes for commits:

```
# Runr checkpoint
feat(task-01): Add project structure

Runr-Run-Id: 20260106-001122
Runr-Checkpoint: abc123
Runr-Tier: tier2

# Manual intervention
fix: TS error in game.ts

Runr-Run-Id: 20260106-002233
Runr-Intervention: true
```

**Why:** Git history becomes self-documenting.

---

### 5. Config: Mode Switch (Priority: Medium)

```json
// .runr/runr.config.json
{
  "workflow": {
    "mode": "flow"  // or "ledger"
  }
}
```

Or per-orchestration:
```yaml
# .runr/orchestration.yaml
mode: ledger
tasks:
  - task-01.md
  - task-02.md
```

**Why:** Explicit about which rules apply.

---

## Migration / Rollout

1. **v0.6.0** - Add `runr intervene` + `runr audit` (core provenance tools)
2. **v0.6.1** - Add review loop diagnostics
3. **v0.7.0** - Add mode switch + ledger mode enforcement

Start permissive (flow mode default), tighten later.

---

## Open Questions

1. Should `runr audit` be a separate command or part of `runr status --history`?
2. How much stdout/stderr to capture in intervention records? (Full? Truncated? Pointer to file?)
3. Should mode be config-level or orchestration-level or both?
4. What's the right UX for the meta-agent to call `runr intervene`? (Auto-prompt? Hook?)

---

## Success Criteria

After v0.6.0, you should be able to:

1. Run a mixed Runr + manual workflow on a project
2. Run `runr audit` and see the full timeline with no unexplained gaps
3. Every commit is either a Runr checkpoint OR has an intervention record
4. Review loops produce actionable diagnostics, not just "stopped"

---

## Related Work

- Run Receipt v1 (already shipped) - foundation for receipts
- `runr meta` command (in progress) - launches agent with context
- `--with-claude` flag (planned) - scaffolds CLAUDE.md + skills
